import React, { Component } from 'react';
import { FetchAllRoutes, FetchRouteInfo, DivideRoute } from './webapi';
import { CreatePointFeature } from './security-route-layer';

export default class ViewRoute extends Component {
  state = {
    routeList: []
  };

  componentDidMount = () => this._init();

  componentWillUnmount = () => this._reset();

  render() {
    const { routeList } = this.state;
    return (
      <div className="view-route">
        重大安保轨迹
        {routeList.map((item, index) => {
          return (
            <div
              key={`route_list_${index}`}
              onClick={() => this._fetchRouteInfo(item)}
            >
              {item}
            </div>
          );
        })}
      </div>
    );
  }

  _init = async () => {
    const { res, err } = await FetchAllRoutes();
    if (!res || err) return console.log('获取重大安保轨迹失败');
    this.setState({ routeList: res });
    this._divideRoute();
  };

  _reset = () => {};

  _fetchRouteInfo = async routeName => {
    const { res, err } = await FetchRouteInfo({ fileName: routeName });
    if (!res || err) return console.log('获取重大安保轨迹详情失败');
    console.log(res);
  };

  _divideRoute = async () => {
    console.log('%c _divideRoute', 'color: green');
    const { res, err } = await DivideRoute({ coordinates: routeCoord });
    console.log(res, err);
    let ind = 0;
    const _interval = setInterval(() => {
      if (ind >= res.length) return;

      const _feature = CreatePointFeature({
        coordinates: [res[ind].x, res[ind].y]
      });
      ind++;

      if (!_MAP_.getSource('RouteLayers.routeStart'))
        _MAP_.addLayer({
          id: 'RouteLayers.routeStart',
          type: 'circle',
          source: {
            type: 'geojson',
            data: {
              type: 'FeatureCollection',
              features: [_feature]
            }
          },
          paint: {
            'circle-radius': {
              base: 5,
              stops: [[10, 5], [20, 20]]
            },
            'circle-color': '#e55e5e'
          }
        });
      else
        _MAP_.getSource('RouteLayers.routeStart').setData({
          type: 'FeatureCollection',
          features: [_feature]
        });
    }, 10);
  };
}

const routeCoord = [];
[
  {
    type: 'Feature',
    geometry: {
      type: 'LineString',
      coordinates: [
        [117.06741356198734, 36.66712691087912],
        [117.06890116565728, 36.668411355000956],
        [117.06967736062279, 36.66912832241502],
        [117.07014455752642, 36.66956339823315],
        [117.07046699865407, 36.66983976349519],
        [117.07090960359642, 36.67016210479818],
        [117.07104502620803, 36.670242414256904],
        [117.0712243168498, 36.67034711422883],
        [117.07148933806354, 36.67048635446258],
        [117.07194921988162, 36.67068470893304],
        [117.07229791581722, 36.67087584814277],
        [117.07248678244014, 36.67095756593983],
        [117.07400522656098, 36.671634773426945],
        [117.07437134236466, 36.67179117722196],
        [117.07485399681559, 36.67199897817119],
        [117.07562255833545, 36.672359566741534],
        [117.07631693657845, 36.67267427909559],
        [117.07680712195213, 36.67288790225575],
        [117.07788858908816, 36.67334948109459],
        [117.078487496202, 36.67356290280662],
        [117.07884979168557, 36.67367182149826],
        [117.07915888237756, 36.67374239489652],
        [117.07944096732786, 36.67378997802598],
        [117.07962493354489, 36.67382573956712],
        [117.08007822063439, 36.67391395496594],
        [117.08085431577513, 36.67406835147415],
        [117.08328437837247, 36.674549199187084],
        [117.08681859530304, 36.67522631044676],
        [117.0905953458996, 36.675941566451],
        [117.09097490386978, 36.67601775701479],
        [117.09198580300347, 36.67621993989923],
        [117.09246053172922, 36.676313301218784],
        [117.09366998678149, 36.67655753999935],
        [117.09452056467342, 36.676719766005306],
        [117.09581699945602, 36.67696651929032],
        [117.09777460141777, 36.67733965340318],
        [117.09818468147898, 36.67741775502628],
        [117.09827242383437, 36.677434916788854],
        [117.10001010558301, 36.677770397186976],
        [117.10257097097463, 36.678265082768235],
        [117.10354935422038, 36.67845336213384],
        [117.10359599755827, 36.67846216200007],
        [117.10359593640442, 36.67846236884412],
        [117.10413370220965, 36.67856607506519],
        [117.10478390845162, 36.67869196396384],
        [117.10662259215997, 36.67904673122257],
        [117.10857591694605, 36.67942418208122],
        [117.10860452707834, 36.67942990806472],
        [117.10932911085081, 36.67957178421136],
        [117.10934074178283, 36.679573957872776],
        [117.10945329643357, 36.679595948095425],
        [117.10971058887367, 36.679645534015094],
        [117.11148462391736, 36.67999086918417],
        [117.11324872504963, 36.68032274240153],
        [117.1133727991164, 36.68034553481948],
        [117.11411475689158, 36.680498119193715],
        [117.1142750736368, 36.68053054784741],
        [117.11474217521231, 36.68064117525091],
        [117.11528777591116, 36.68078813616444],
        [117.11537752195613, 36.680820365168586],
        [117.11561022243484, 36.68090067282867],
        [117.11571321909082, 36.680930987176225],
        [117.11591539837798, 36.68100356696192],
        [117.11640176882759, 36.68120966369594],
        [117.11744699598319, 36.68170156047955],
        [117.11762247170077, 36.68178738727897],
        [117.11831092431078, 36.68212137300384],
        [117.1196707639956, 36.68277941144157],
        [117.12037477577633, 36.68312272943132],
        [117.12169657144068, 36.68376741923191],
        [117.1222229967949, 36.68402471077269],
        [117.123424526122, 36.684589485916945],
        [117.12387852367601, 36.68480307040625],
        [117.1238785749373, 36.68480310907711],
        [117.12491797988196, 36.68529710847565],
        [117.12557792308371, 36.68562517216486],
        [117.12631215208523, 36.68598756747315],
        [117.1273671162005, 36.68648518574361],
        [117.12805938283532, 36.686802006108564],
        [117.12937746070236, 36.68745050453805],
        [117.13014802950897, 36.68782053059391],
        [117.1301690070951, 36.68783197446692],
        [117.13173092894033, 36.68858517736493],
        [117.13329010515531, 36.68936058632289],
        [117.13428887962914, 36.689861393589354],
        [117.13464736558456, 36.6900309481706],
        [117.13567151173197, 36.69053077337736],
        [117.1368180277309, 36.691039938942936],
        [117.13706779104677, 36.69116411283443],
        [117.13749193740409, 36.69137506860545],
        [117.13895797443206, 36.69210433604718],
        [117.13917159579353, 36.69220532541635],
        [117.14037894823093, 36.692781543534295],
        [117.14095878162357, 36.69304285504461],
        [117.14122972487291, 36.69316682838729]
      ]
    },
    properties: { roadMark: '箭头' }
  },
  {
    type: 'Feature',
    geometry: {
      type: 'LineString',
      coordinates: [
        [117.1238785749373, 36.68480310907711],
        [117.12424458641954, 36.68431271685927],
        [117.12448110182243, 36.68399037825424],
        [117.12600336446474, 36.68194198703395],
        [117.12631215208523, 36.68153200140165],
        [117.12659654649451, 36.681129554786025],
        [117.12662325006397, 36.68110285301515],
        [117.12672052523317, 36.68096733057877],
        [117.12692631799621, 36.6806832356437],
        [117.12714395573005, 36.68041419985633],
        [117.12778653212376, 36.67954254095639],
        [117.1283187868836, 36.678833108062406],
        [117.12862024413005, 36.678422928176474],
        [117.12884892643785, 36.678110218612574],
        [117.1295737179538, 36.67709360158932],
        [117.12972650557481, 36.676877971142346],
        [117.12983331805424, 36.67673673261504],
        [117.13001833108217, 36.6763915970954],
        [117.13002214510698, 36.67637252427346],
        [117.13023757500514, 36.675657168444445],
        [117.13027752918572, 36.6755047837197],
        [117.13027772883515, 36.67526064386453],
        [117.13028535868341, 36.67510996245568],
        [117.1302871672201, 36.6748123129388],
        [117.13029489599376, 36.67465791822923],
        [117.1302871672201, 36.674583534403496],
        [117.13022813841894, 36.674430743185155],
        [117.13018035474067, 36.67426872312399],
        [117.13010858884138, 36.674026613938],
        [117.12995157260809, 36.67363748538253],
        [117.12993992908548, 36.67361078271233],
        [117.12980570886748, 36.67325895084082]
      ]
    },
    properties: { roadMark: '箭头' }
  },
  {
    type: 'Feature',
    geometry: {
      type: 'LineString',
      coordinates: [
        [117.12387852367601, 36.68480307040625],
        [117.12387814506144, 36.68480344452422],
        [117.12380788462724, 36.685162413415526],
        [117.12371292791033, 36.685513386434536],
        [117.12359376504128, 36.68605252640384]
      ]
    },
    properties: { roadMark: '箭头' }
  }
].map(item => {
  for (let coord of item.geometry.coordinates) {
    routeCoord.push(coord);
  }
});
